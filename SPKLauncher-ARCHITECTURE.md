# SPKLauncher — Архитектурное описание

**Издатель:** KreosanX  
**Версия документа:** 1.0  
**Тип:** Desktop-приложение (Windows), с перспективой Android.

---

## 1. Выбор стека: Electron vs Tauri vs CEF

### Сравнение по критериям

| Критерий | Electron | Tauri | CEF (Chromium Embedded) |
|----------|----------|-------|--------------------------|
| **Нагрузка на ПК** | Высокая (отдельный Chromium + Node) | Низкая (системный WebView2 / WebKit) | Средняя (свой Chromium) |
| **Бесплатность** | MIT | MIT/Apache | BSD |
| **Мессенджер (сокеты, фоны)** | Удобно | Удобно (Rust backend) | Нужен C++/C# host |
| **Встроенный браузер** | Уже внутри Chromium | Нужен WebView на вкладку | Нативная интеграция |
| **Production-ready** | Да | Да (моложе) | Да, сложнее сборка |
| **Кроссплатформа** | Win/Mac/Linux | Win/Mac/Linux | Win/Mac/Linux |
| **Android** | Тяжело, неофициально | Официальная поддержка (alpha/beta) | Сложно |

### Рекомендация: **Tauri 2.x**

**Обоснование:**

1. **Минимальная нагрузка на ПК** — UI рендерится в системном WebView2 (Windows), без дублирования движка. Процесс мессенджера и браузера можно изолировать; Rust даёт контроль над памятью и CPU.
2. **Бесплатно и открыто** — лицензии Apache-2.0/MIT, без vendor lock-in.
3. **Мессенджер + браузер** — фронт на HTML/CSS/JS (или React/Vue/Svelte); тяжёлая логика (сокеты, шифрование, кэш, БД) в Rust (core). Вкладки браузера — отдельные WebView или встроенный движок через Tauri.
4. **Production-ready** — Tauri 2 стабилен, используется в коммерческих продуктах; обновления безопасности через системный WebView2.
5. **Будущий Android-клиент** — у Tauri есть направление на Android (WebView + Rust core), архитектура «тонкий UI + общий core» этому способствует.
6. **Без заглушек** — Rust core изначально проектируется под реальные API (REST/WebSocket/протоколы мессенджера и браузера).

**Альтернатива:** если команда не готова к Rust, разумный компромисс — **Electron** с жёсткой оптимизацией (один общий процесс, ленивая загрузка модулей, отключение Node в рендерерах где возможно). CEF оправдан только при необходимости глубокой кастомизации движка или уже имеющемся C++ стеке.

---

## 2. Структура проекта (папки и модули)

```
spk-launcher/
├── src-tauri/                    # Rust backend (core)
│   ├── src/
│   │   ├── main.rs
│   │   ├── lib.rs
│   │   ├── core/                 # Core
│   │   │   ├── mod.rs
│   │   │   ├── config.rs
│   │   │   ├── storage.rs
│   │   │   ├── events.rs
│   │   │   └── ipc.rs
│   │   ├── auth/                 # Auth
│   │   │   ├── mod.rs
│   │   │   ├── session.rs
│   │   │   ├── tokens.rs
│   │   │   └── crypto.rs
│   │   ├── messenger/            # Messenger
│   │   │   ├── mod.rs
│   │   │   ├── connection.rs
│   │   │   ├── protocol.rs
│   │   │   ├── channels.rs
│   │   │   ├── messages.rs
│   │   │   └── media.rs
│   │   ├── browser/              # Browser
│   │   │   ├── mod.rs
│   │   │   ├── engine.rs
│   │   │   ├── tabs.rs
│   │   │   ├── profile.rs
│   │   │   └── storage.rs
│   │   ├── premium/              # Premium
│   │   │   ├── mod.rs
│   │   │   ├── entitlements.rs
│   │   │   └── licensing.rs
│   │   └── admin/                # Admin / Bot
│   │       ├── mod.rs
│   │       ├── commands.rs
│   │       └── moderation.rs
│   └── Cargo.toml
│
├── src/                          # Frontend (UI)
│   ├── index.html
│   ├── main.ts
│   ├── core/                     # UI Core (router, state, i18n)
│   │   ├── router.ts
│   │   ├── store/
│   │   └── i18n/
│   ├── features/
│   │   ├── auth/
│   │   ├── messenger/
│   │   ├── browser/
│   │   ├── premium/
│   │   └── admin/
│   ├── shared/                   # UI/Animations, общие компоненты
│   │   ├── ui/
│   │   ├── animations/
│   │   └── theme/
│   └── locales/                  # i18n
│       ├── en.json
│       ├── ru.json
│       └── ...
│
├── crates/                       # (опционально) Общий Rust-код для desktop + будущий Android
│   └── spk-core/
│       ├── src/
│       │   ├── lib.rs
│       │   ├── auth/
│       │   ├── messenger/
│       │   ├── browser/
│       │   └── ...
│       └── Cargo.toml
│
├── docs/
│   └── ARCHITECTURE.md
├── package.json
├── tauri.conf.json
└── README.md
```

- **Core** — конфиг, хранилище, события, IPC.  
- **Auth** — сессии, токены, крипто.  
- **Messenger** — соединение, протокол, каналы, сообщения, медиа.  
- **Browser** — движок/вкладки, профиль, хранилище браузера.  
- **Premium** — права доступа, лицензии.  
- **Admin/Bot** — команды, модерация.  
- **UI/Animations** — в `shared/` на фронте; анимации и тема вынесены в отдельные подпапки.

---

## 3. Разделение доменов (модули)

### 3.1 Core

- **Назначение:** конфигурация приложения, постоянное хранилище (настройки, кэш, ключи), шина событий, IPC между frontend и backend.
- **Компоненты:** `config`, `storage`, `events`, `ipc`.
- **Зависимости:** только стандартная библиотека и выбранные крэйты (serde, tokio и т.д.). Остальные модули зависят от Core, не наоборот.
- **Кроссплатформенность:** весь код Core пишется без привязки к Tauri/Windows, чтобы позже вынести в `crates/spk-core` для Android.

### 3.2 Auth

- **Назначение:** аутентификация и сессии (логин, токены, refresh, выход).
- **Компоненты:** управление сессией, хранение/обновление токенов, при необходимости — крипто для локальных данных.
- **Интеграция:** Messenger и Premium используют Auth для проверки идентичности и прав; Browser может иметь отдельный профиль, привязанный к аккаунту.

### 3.3 Messenger

- **Назначение:** логика мессенджера уровня Telegram/Discord (каналы, чаты, сообщения, медиа, уведомления).
- **Компоненты:** установка и поддержка соединения (WebSocket/другое), разбор протокола, сущности (каналы, треды, сообщения), загрузка/кэш медиа.
- **Требования:** минимизация фоновой нагрузки (один долгоживущий сокет, батчинг событий, ленивая подгрузка истории).

### 3.4 Browser

- **Назначение:** встроенный браузер уровня Opera GX (вкладки, профиль, история, закладки, при необходимости — блокировка рекламы/расширения).
- **Компоненты:** управление «движком» (WebView2), пул вкладок, изолированный профиль и хранилище (cookies, cache, localStorage), API для UI (новый таб, навигация, devtools).
- **Требования:** изоляция от мессенджера по памяти; использование одного WebView2 на вкладку или переиспользование — в зависимости от ограничений Tauri и нагрузки.

### 3.5 Premium

- **Назначение:** монетизация и премиум-функции (подписка, разблокировка возможностей).
- **Компоненты:** проверка прав (entitlements), при необходимости — лицензирование (ключи, сервер проверки).
- **Интеграция:** Auth даёт идентификатор; Premium решает, доступны ли расширенные функции мессенджера/браузера/админки.

### 3.6 Admin / Bot

- **Назначение:** админ-функции и бот-команды (модерация, служебные команды, интеграции).
- **Компоненты:** разбор команд, вызов логики модерации, при необходимости — отдельный слой для ботов/интеграций.
- **Доступ:** только для пользователей с соответствующими правами (проверка через Auth + Premium/роли).

### 3.7 UI / Animations

- **Назначение:** единый внешний вид, анимации, темы, доступность.
- **Размещение:** фронтенд, папка `shared/` (компоненты, тема, анимации).
- **Требования:** лёгкие анимации (CSS/GPU), без лишних тяжёлых библиотек; учёт системной темы и высокой контрастности при необходимости.

---

## 4. Поток данных

- **Направления:**
  - **Backend → Frontend:** события (новое сообщение, смена таба, результат проверки Premium) через Tauri Events или команды (invoke).
  - **Frontend → Backend:** команды (отправить сообщение, открыть URL, запрос прав) через Tauri invoke.
- **Auth:** логин/логаут идут через Backend; токены хранятся только в Rust (или в защищённом хранилище ОС), фронт получает только факт «авторизован» и профиль.
- **Messenger:** backend держит соединение и парсит протокол; новые сообщения/каналы приходят как события; медиа запрашиваются по требованию (ленивая загрузка).
- **Browser:** навигация и создание вкладок — по запросу UI; события (загрузка, title) — от backend к UI.
- **Premium:** проверка при старте и при доступе к премиум-функциям; результат кэшируется на сессию с TTL.
- **Единый источник правды:** состояние мессенджера и браузера живёт в backend; фронт — отображение и триггеры действий. Это упрощает будущий Android-клиент (тот же core, другой UI).

Схема (текстом):

```
[UI] ←→ invoke/events ←→ [Tauri Core]
                              ↓
                    [Auth] [Messenger] [Browser] [Premium] [Admin]
                              ↓
                    [Storage] [Network] [WebView2]
```

---

## 5. Учёт будущего Android-клиента

- **Общий core:** логику Auth, Messenger, Premium, протоколы и хранилище вынести в отдельный крэйт (например `crates/spk-core`) без зависимостей от Tauri/Windows. Desktop (Tauri) и Android (Tauri для Android или отдельный нативный UI) подключают этот крэйт.
- **API core:** чёткий контракт «команды + события» (например trait `CoreCommand` / `CoreEvent` в Rust), чтобы UI на любой платформе вызывал одни и те же операции и подписывался на одни и те же события.
- **Browser на Android:** на мобильном «браузер» может быть упрощён (in-app WebView или переход во внешний браузер); интерфейс core должен это допускать (режим «только мессенджер» или «мессенджер + простой WebView»).
- **Конфиг и хранилище:** пути и способы доступа к БД/файлам абстрагировать (platform-specific в одном слое), чтобы на Android использовать свой root для данных.

---

## 6. Локализация (i18n)

- **Место:** только на уровне frontend (строки интерфейса).
- **Механизм:** файлы в `src/locales/` (например `en.json`, `ru.json`) с ключами по фичам (auth, messenger, browser, premium, admin, common).
- **Инициализация:** при старте приложения загружать выбранную локаль (из настроек Core); смена языка — через команду к backend (сохранение в настройках) и перезагрузка словарей на фронте.
- **Backend:** не хранит пользовательские строки для UI; при необходимости только коды ошибок или enum, которые фронт переводит по ключам.
- **Формат:** JSON или стандарт i18next/formatjs — на выбор команды; важно единообразие ключей и неймспейсов по модулям (auth.login, messenger.channels и т.д.).

---

## 7. Итог

- **Стек:** Tauri 2.x (Rust + WebView2), фронт на выбранном фреймворке (React/Vue/Svelte) + TypeScript.
- **Структура:** разделение на Core, Auth, Messenger, Browser, Premium, Admin/Bot и UI/Animations с чёткой иерархией и потоком данных.
- **Данные:** backend — источник правды; UI — отображение и вызов команд; события и invoke — единственный канал связи.
- **Android:** общий Rust core в отдельном крэйте, платформо-специфичный UI и минимальные обёртки для хранилища/сети.
- **i18n:** централизованные словари на фронте, ключи по модулям, смена языка через настройки в Core.

Документ можно использовать как основу для технического задания и следующих шагов (детализация API модулей, выбор протокола мессенджера, дизайн БД и т.д.).
